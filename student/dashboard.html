<!DOCTYPE html>
<html lang="en">

<head>
    <meta name="view-transition" content="same-origin">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Dashboard | Student Portal</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="/src/style.css">
    <link rel="stylesheet" href="/src/student.css">
</head>

<body>
    <nav class="navbar scrolled">
        <div class="nav-container">
            <a href="/" class="logo">
                <img src="/logo.png" alt="St. John Paul II" style="height: 50px;">
                <span style="margin-left: 10px; font-weight: 700;">Student Portal</span>
            </a>
            <div class="nav-links">
                <a href="/student/dashboard.html" class="active"><i class="fas fa-home"></i> Dashboard</a>
                <a href="/student/curriculum.html"><i class="fas fa-book"></i> Curriculum</a>
                <a href="/student/logout.html" class="btn-logout"><i class="fas fa-sign-out-alt"></i> Logout</a>
            </div>
        </div>
    </nav>

    <div class="portal-container">
        <div class="welcome-card">
            <h1 id="welcomeName">Welcome Back</h1>
            <p>Student Portal Dashboard</p>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('overview')"><i class="fas fa-home me-2"></i>
                Overview</button>
            <button class="tab-btn" onclick="switchTab('academics')"><i class="fas fa-graduation-cap me-2"></i>
                Academics</button>
            <button class="tab-btn" onclick="switchTab('school-life')"><i class="fas fa-bullhorn me-2"></i> School
                Life</button>
            <button class="tab-btn" onclick="switchTab('settings')"><i class="fas fa-cog me-2"></i> Settings</button>
        </div>

        <!-- OVERVIEW TAB -->
        <div id="overview" class="tab-content active">
            <div class="grid-cards">
                <!-- Profile -->
                <div class="card">
                    <h3><i class="fas fa-id-card me-2"></i> My Profile</h3>
                    <!-- Profile Photo Addition -->
                    <div style="text-align: center; margin-bottom: 15px;">
                        <img src="" id="studentProfileImg" onerror="this.src='/assets/avatars/student-default.png'"
                            style="width: 100px; height: 100px; border-radius: 50%; border: 4px solid var(--school-orange); object-fit: cover;">
                    </div>

                    <div class="info-row"><span class="info-label">Full Name</span><span class="info-val"
                            id="pName">-</span></div>
                    <div class="info-row"><span class="info-label">Reg Number</span><span class="info-val"
                            id="pReg">-</span></div>
                    <div class="info-row"><span class="info-label">Class</span><span class="info-val"
                            id="pClass">-</span></div>
                    <div class="info-row"><span class="info-label">Stream</span><span class="info-val"
                            id="pStream">-</span></div>
                    <div class="info-row"><span class="info-label">Parent Name</span><span class="info-val"
                            id="pParent">-</span></div>
                </div>

                <!-- Finance -->
                <div class="card">
                    <h3><i class="fas fa-wallet me-2"></i> Financial Status</h3>
                    <div class="balance-box">
                        Outstanding Balance
                        <span class="balance-amount" id="feeBalance">UGX 0</span>
                    </div>
                    <h4 style="margin-top: 25px; margin-bottom: 15px;">Recent Transactions</h4>
                    <ul id="feeHistory" style="list-style: none; padding: 0; font-size: 0.9rem;">
                        <li style="color: #666; font-style: italic;">Loading...</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- ACADEMICS TAB -->
        <div id="academics" class="tab-content">
            <div class="grid-cards">
                <!-- Results -->
                <div class="card" style="grid-column: span 1;">
                    <h3><i class="fas fa-star me-2"></i> Recent Results</h3>
                    <div class="table-responsive">
                        <table class="table" id="resultsTable">
                            <thead>
                                <tr>
                                    <th>Subject</th>
                                    <th>Term</th>
                                    <th>Mark</th>
                                    <th>Grade</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="4">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Timetable -->
                <div class="card" style="grid-column: span 1;">
                    <h3><i class="fas fa-clock me-2"></i> My Timetable</h3>
                    <div class="table-responsive">
                        <table class="table" id="timetableTable">
                            <thead>
                                <tr>
                                    <th>Day</th>
                                    <th>Time</th>
                                    <th>Subject</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="3">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Curriculum Link -->
                <div class="card"
                    style="grid-column: span 1; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;">
                    <i class="fas fa-book-open"
                        style="font-size: 3rem; color: var(--school-red); margin-bottom: 20px;"></i>
                    <h3 style="border: none; padding: 0; margin-bottom: 10px;">School Curriculum</h3>
                    <p style="color: #666; margin-bottom: 20px;">View all subjects and course details.</p>
                    <a href="/student/curriculum.html" class="btn btn-outline-primary"
                        style="text-decoration: none; padding: 10px 25px; border: 2px solid var(--school-red); color: var(--school-red); font-weight: 600; border-radius: 6px;">
                        View Curriculum
                    </a>
                </div>
            </div>
        </div>

        <!-- SCHOOL LIFE TAB -->
        <div id="school-life" class="tab-content">
            <div class="grid-cards">
                <!-- Updates -->
                <div class="card">
                    <h3><i class="fas fa-newspaper me-2"></i> Latest News</h3>
                    <div id="newsList">Loading...</div>
                </div>

                <!-- Events & Docs -->
                <div class="card">
                    <h3><i class="fas fa-calendar-alt me-2"></i> Upcoming Events</h3>
                    <ul id="eventsList" style="list-style: none; padding: 0; margin-bottom: 30px;">
                        <li>Loading...</li>
                    </ul>

                    <h3><i class="fas fa-file-download me-2"></i> Downloads</h3>
                    <ul id="docsList" style="list-style: none; padding: 0;">
                        <li>Loading...</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- SETTINGS TAB -->
        <div id="settings" class="tab-content">
            <div class="card" style="max-width: 600px; margin: 0 auto;">
                <h3><i class="fas fa-lock me-2"></i> Account Security</h3>
                <form id="changePasswordForm">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Current Password</label>
                        <input type="password" id="currentPass" required
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">New Password</label>
                        <input type="password" id="newPass" required
                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                    </div>
                    <button type="submit" class="btn btn-outline-primary"
                        style="background: var(--school-red); color: white; width: 100%;">
                        Update Password
                    </button>
                </form>
            </div>
        </div>

        <div style="text-align: center; margin-top: 40px; margin-bottom: 40px;">
            <a href="/student/logout.html" id="logoutBtn" class="btn btn-outline-primary"
                style="text-decoration: none; display: inline-block; padding: 10px 25px; background-color:#8B0000; color: white;">
                <i class="fas fa-sign-out-alt"></i> Logout
            </a>
        </div>
    </div>

    <script type="module" src="/src/main.js"></script>
    <script type="module">
        import { API_URL, getImageUrl } from '/src/config.js';
        import { logout, getCurrentUser } from '/src/utils/auth.js';

        const user = getCurrentUser();
        if (!user || user.role !== 'student') window.location.href = '/login.html';

        // NOTE: Logout button is now a direct link to logout.html, so we don't attach the 'logout' function listener
        document.getElementById('welcomeName').textContent = `Welcome, ${user.username}`;

        // Populate profile image based on name
        const profileImg = `https://ui-avatars.com/api/?name=${user.username.replace(' ', '+')}&size=200&background=FFA500&color=fff`;
        document.getElementById('studentProfileImg').src = profileImg;

        // Tab Logic
        window.switchTab = (tabId) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));

            document.getElementById(tabId).classList.add('active');
            event.target.closest('.tab-btn').classList.add('active');
        };

        const token = localStorage.getItem('token');
        const headers = { 'Authorization': `Bearer ${token}` };

        async function loadProfile() {
            try {
                const res = await fetch(`${API_URL}/portal/profile`, { headers });
                if (res.ok) {
                    const p = await res.json();
                    document.getElementById('pName').textContent = p.full_name;
                    document.getElementById('pReg').textContent = p.reg_number;
                    document.getElementById('pClass').textContent = p.class_level;
                    document.getElementById('pStream').textContent = p.stream || 'N/A';
                    document.getElementById('pParent').textContent = p.parent_name || 'N/A';

                    const profileImg = `https://ui-avatars.com/api/?name=${p.full_name.replace(' ', '+')}&size=200&background=FFA500&color=fff`;
                    document.getElementById('studentProfileImg').src = profileImg;
                    document.getElementById('welcomeName').textContent = `Welcome, ${p.full_name.split(' ')[0]}`;
                }
            } catch (e) { console.warn('Profile fail', e); }
        }

        async function loadFees() {
            try {
                const res = await fetch(`${API_URL}/portal/fees`, { headers });
                if (res.ok) {
                    const f = await res.json();
                    document.getElementById('feeBalance').textContent = `UGX ${f.balance.toLocaleString()}`;
                    const list = document.getElementById('feeHistory');
                    list.innerHTML = '';
                    if (!f.history || f.history.length === 0) list.innerHTML = '<li style="color:#888;">No recent transactions.</li>';
                    else {
                        f.history.slice(0, 5).forEach(pay => {
                            list.innerHTML += `
                                <li style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f0f0f0;">
                                    <span>${pay.type} <span style="font-size:0.85rem; color:#888;">(${new Date(pay.date).toLocaleDateString()})</span></span>
                                    <span style="color: #c62828; font-weight: 600;">+${pay.amount.toLocaleString()}</span>
                                </li>
                            `;
                        });
                    }
                }
            } catch (e) { console.warn('Fees fail', e); }
        }

        async function loadMarks() {
            try {
                const res = await fetch(`${API_URL}/portal/marks`, { headers });
                if (res.ok) {
                    const marks = await res.json();
                    const tbody = document.querySelector('#resultsTable tbody');
                    tbody.innerHTML = '';
                    if (marks.length === 0) tbody.innerHTML = '<tr><td colspan="4">No results published yet.</td></tr>';
                    else {
                        marks.forEach(m => {
                            tbody.innerHTML += `
                                <tr>
                                    <td>${m.Subject ? m.Subject.name : m.subject_code}</td>
                                    <td>${m.term} ${m.year}</td>
                                    <td>${m.score}%</td>
                                    <td><span class="badge" style="background:#e3f2fd; color:#1565c0;">${m.grading}</span></td>
                                </tr>
                            `;
                        });
                    }
                }
            } catch (e) { console.warn('Marks fail', e); }
        }

        function loadAllData() {
            loadProfile();
            loadFees();
            loadMarks();
            // ... other minor loaders
        }

        // Change Password Logic
        document.getElementById('changePasswordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const currentPassword = document.getElementById('currentPass').value;
            const newPassword = document.getElementById('newPass').value;
            const btn = e.target.querySelector('button');
            const originalText = btn.textContent;

            btn.textContent = 'Updating...';
            btn.disabled = true;

            try {
                const res = await fetch(`${API_URL}/auth/change-password`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ currentPassword, newPassword })
                });

                const data = await res.json();
                if (res.ok) {
                    alert('Password updated successfully!');
                    e.target.reset();
                } else {
                    alert(data.message || 'Error updating password');
                }
            } catch (err) {
                console.error(err);
                alert('Connection error');
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        });

        loadAllData();
    </script>
</body>

</html>