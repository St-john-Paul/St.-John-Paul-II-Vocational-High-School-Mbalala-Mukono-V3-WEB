<!DOCTYPE html>
<html lang="en">

<head>
    <meta name="view-transition" content="same-origin">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timetable | Staff Portal</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="/src/style.css">
    <link rel="stylesheet" href="/src/staff.css">
    <style>
        :root {
            --school-red: #8B0000;
            --school-orange: #FFA500;
        }

        .timetable-card {
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            padding: 20px;
            overflow-x: auto;
        }

        .timetable-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        .timetable-table th,
        .timetable-table td {
            padding: 15px;
            border: 1px solid #eee;
            text-align: center;
        }

        .timetable-table th {
            background: #f8f9fa;
            color: var(--school-red);
            font-weight: 600;
        }

        .lesson-slot {
            background: #fff;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #eee;
        }

        .lesson-slot.active {
            background: #fff5f5;
            border-color: #ffdce0;
        }

        .lesson-slot .subject {
            font-weight: bold;
            display: block;
            color: #333;
        }

        .lesson-slot .class-info {
            font-size: 0.85rem;
            color: #666;
        }
    </style>
</head>

<body class="staff-page">
    <!-- Mobile Toggle -->
    <button class="menu-toggle" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </button>
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <img src="/logo.png" alt="Logo">
            <h3>St. John Paul II<br>Staff Portal</h3>
        </div>

        <div class="sidebar-menu">
            <div class="sidebar-label">Main</div>
            <a href="/staff/dashboard.html"><i class="fas fa-home"></i> Dashboard</a>
            <a href="/staff/marks.html"><i class="fas fa-edit"></i> Enter Marks</a>
            <a href="/staff/my-classes.html"><i class="fas fa-users"></i> My Classes</a>

            <div class="sidebar-label">Academics</div>
            <a href="/staff/timetable.html" class="active"><i class="fas fa-calendar-alt"></i> Timetable</a>
            <a href="/staff/curriculum.html"><i class="fas fa-book-open"></i> Curriculum</a>

            <div class="sidebar-label">Account</div>
            <a href="/staff/settings.html"><i class="fas fa-cog"></i> Settings</a>
        </div>

        <div class="sidebar-footer">
            <a href="/index.html"><i class="fas fa-arrow-left"></i> Back to System</a>
            <a href="/staff/logout.html"><i class="fas fa-sign-out-alt"></i> Logout</a>
        </div>
    </nav>

    <div class="main-content">
        <h2 style="margin-bottom: 25px; color: var(--school-red);">School Timetables</h2>

        <div
            style="margin-bottom: 20px; background: white; padding: 20px; border-radius: 12px; box-shadow: var(--shadow-sm);">
            <label style="font-weight: 600; margin-right: 15px;">Select Class:</label>
            <select id="classFilter" onchange="loadTimetable()"
                style="padding: 8px 15px; border: 1px solid #ddd; border-radius: 6px;">
                <option value="S.1">Senior One (S.1)</option>
                <option value="S.2">Senior Two (S.2)</option>
                <option value="S.3">Senior Three (S.3)</option>
                <option value="S.4">Senior Four (S.4)</option>
                <option value="S.5">Senior Five (S.5)</option>
                <option value="S.6">Senior Six (S.6)</option>
            </select>
        </div>

        <div class="timetable-card">
            <h3 id="timetableTitle"
                style="color: var(--school-red); border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 20px;">
                Timetable for S.1
            </h3>
            <table class="timetable-table">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Monday</th>
                        <th>Tuesday</th>
                        <th>Wednesday</th>
                        <th>Thursday</th>
                        <th>Friday</th>
                    </tr>
                </thead>
                <tbody id="timetableBody">
                    <tr>
                        <td colspan="6">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script type="module">
        import { API_URL, getImageUrl } from '/src/config.js';
        import { logout, getCurrentUser } from '/src/utils/auth.js';

        // Mobile Sidebar Toggle
        window.toggleSidebar = () => {
            document.getElementById('sidebar').classList.toggle('active');
            const overlay = document.querySelector('.sidebar-overlay');
            if (overlay) overlay.classList.toggle('active');
        };

        const user = getCurrentUser();
        if (!user || user.role !== 'staff') {
            window.location.href = '/login.html';
        }

        window.loadTimetable = async () => {
            const classLevel = document.getElementById('classFilter').value || 'S.1';
            document.getElementById('timetableTitle').textContent = `Timetable for ${classLevel}`;

            try {
                // Fetch Class Timetable
                const res = await fetch(`${API_URL}/content/timetable?type=class&class_level=${classLevel}`);
                const entries = await res.json();

                renderTable(entries);
            } catch (e) {
                console.error(e);
                document.getElementById('timetableBody').innerHTML = '<tr><td colspan="6">Error loading timetable</td></tr>';
            }
        };

        function renderTable(entries) {
            const tbody = document.getElementById('timetableBody');
            tbody.innerHTML = '';

            const times = [
                "08:00 - 09:00", "09:00 - 10:00", "10:00 - 10:30",
                "10:30 - 11:30", "11:30 - 12:30", "12:30 - 14:00",
                "14:00 - 15:00", "15:00 - 16:00", "16:00 - 17:00"
            ];

            const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"];

            times.forEach(timeRange => {
                const [start, end] = timeRange.split(' - ');

                // Check if it's a break/lunch (simple logic: 10:00 or 12:30)
                const isBreak = start === '10:00' || start === '12:30';

                if (isBreak) {
                    const label = start === '12:30' ? 'LUNCH BREAK' : 'TEA BREAK';
                    tbody.innerHTML += `<tr><td colspan="6" style="background:#f1f1f1; font-weight:bold; color:#666; text-align:center;">${label} (${timeRange})</td></tr>`;
                    return;
                }

                let rowHtml = `<tr><td style="font-weight:bold;">${timeRange}</td>`;

                days.forEach(day => {
                    // Find entry for this day + time range (approximate match on start time)
                    const lesson = entries.find(e => e.day === day && e.start_time === start);

                    if (lesson) {
                        rowHtml += `
                            <td>
                                <div class="lesson-slot">
                                    <span class="subject">${lesson.subject}</span>
                                    <span class="class-info">${lesson.class_level}</span>
                                </div>
                            </td>`;
                    } else {
                        rowHtml += `<td>-</td>`;
                    }
                });

                rowHtml += `</tr>`;
                tbody.innerHTML += rowHtml;
            });
        }

        loadTimetable();
    </script>
</body>

</html>